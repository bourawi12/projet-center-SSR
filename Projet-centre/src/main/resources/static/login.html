<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Login</title>
</head>
<body>

<h2>Login</h2>

<form id="loginForm">
    <input type="text" name="username" placeholder="Username" required /><br/>
    <input type="password" name="password" placeholder="Password" required /><br/>
    <button type="submit">Login</button>
</form>

<p id="message" style="color:red;"></p>

<script>
// Find elements AFTER they are defined in the HTML body
const form = document.getElementById('loginForm');
const message = document.getElementById('message');

// Ensure 'form' is not null (redundant check, but good practice)
if (form) {
    form.addEventListener('submit', async (e) => {
        // Must be the first thing to stop default form submission/page reload
        e.preventDefault(); 

        const formData = new FormData(form);
        const payload = {
            username: formData.get('username'),
            password: formData.get('password')
        };

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload),
                // credentials: 'include' is important to ensure the browser sends
                // the login request with any existing cookies and receives the new cookie.
                credentials: 'include' 
            });

            if (response.ok) {
                // SUCCESS: The server has set the HTTP-only 'JWT' cookie.
                // We no longer expect a JSON body, resolving the 'Unexpected end of JSON input' error.
                window.location.href = '/welcome.html';
            }
            else {
                // Handle 401 Unauthorized or other errors
                const text = await response.text();
                message.textContent = text || 'Login failed';
            }

        } catch (err) {
            message.textContent = 'Network error';
            console.error(err);
        }
    });
}
</script>

</body>
</html>