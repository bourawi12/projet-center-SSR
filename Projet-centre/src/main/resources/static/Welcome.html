<!DOCTYPE html>
<html>
<head>
    <title>Welcome Dashboard</title>
    <style>
        .dashboard-container { max-width: 600px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; text-align: center; }
        .links a { display: block; margin: 10px 0; padding: 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .links a:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <h2 id="welcomeMessage">Loading...</h2>
    <p>Authentication successful. Accessing personalized dashboard.</p>

    <div id="roleLinks" class="links">
        </div>
    
    <button onclick="logout()">Logout</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', fetchUserData);

    // --- Implement a simple endpoint in AuthRestController: /auth/role ---
    // This endpoint should return the authenticated user's role (e.g., { "role": "ETUDIANT" })
    async function fetchUserData() {
        try {
            // Note: Since the JWT is HttpOnly, we can't read it. We must rely on the server 
            // to check the cookie and return the user's role/details.
            const response = await fetch('/auth/me', {
                method: 'GET',
                credentials: 'include' // Important for sending the JWT cookie
            });

            if (response.ok) {
                const user = await response.json();
                const role = user.role;
                const username = user.username;

                document.getElementById('welcomeMessage').textContent = `Welcome, ${username}! Your role is ${role}.`;
                renderLinks(role);
            } else {
                // If 401/403 (cookie invalid or expired), redirect to login
                window.location.href = '/login.html';
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            window.location.href = '/login.html'; // Redirect on network failure
        }
    }

    function renderLinks(role) {
        const linksDiv = document.getElementById('roleLinks');
        linksDiv.innerHTML = ''; // Clear previous links

        if (role === 'ETUDIANT') {
            linksDiv.innerHTML += '<a href="/etudiant_dashboard.html">View My Inscriptions & Notes</a>';
            linksDiv.innerHTML += '<a href="/etudiant_schedule.html">View My Schedule</a>';
            linksDiv.innerHTML += '<a href="/reports/etudiant/me/moyenne">View My Average (API)</a>';
            linksDiv.innerHTML += '<a href="/etudiant_profile.html">View My Profile</a>';
        } else if (role === 'FORMATEUR') {
            linksDiv.innerHTML += '<a href="/formateur_dashboard.html">View My Courses & Grade Students</a>';
            linksDiv.innerHTML += '<a href="/formateur_profile.html">View My Profile</a>';
            linksDiv.innerHTML += '<a href="/formateur/notes">Manage Notes</a>';
        } else if (role === 'ADMIN') {
            linksDiv.innerHTML += '<a href="/admin/etudiants">Manage All Students</a>';
            linksDiv.innerHTML += '<a href="/admin/formateurs">Manage All Formateurs</a>';
            linksDiv.innerHTML += '<a href="/admin/courses">Manage All Courses</a>';
            linksDiv.innerHTML += '<a href="/admin/inscriptions">Manage Inscriptions</a>';
            linksDiv.innerHTML += '<a href="/admin/sessions">Manage Sessions</a>';
            linksDiv.innerHTML += '<a href="/admin/specialites">Manage Specialites</a>';
            linksDiv.innerHTML += '<a href="/admin/groupes">Manage Groupes</a>';
            linksDiv.innerHTML += '<a href="/admin/seances">Manage Seances</a>';
            linksDiv.innerHTML += '<a href="/admin/reporting">Reporting & Stats</a>';
            linksDiv.innerHTML += '<a href="/admin/notes">View All Notes</a>';
        }
    }
    
    // Simple logout function
    function logout() {
        // Implement a server endpoint (e.g., POST /auth/logout) to clear the JWT cookie.
        // For now, redirecting and letting the token expire or manually clearing storage is the best we can do client-side.
        window.location.href = '/login.html'; 
    }
</script>

</body>
</html>
