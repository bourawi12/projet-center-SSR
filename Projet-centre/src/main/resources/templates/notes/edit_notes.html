<!DOCTYPE html>
<html>
<head>
    <title>Edit Note</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Edit Note</h2>
    <p><a href="javascript:history.back()">Back</a></p>

    <form id="noteForm" style="display:none;">
        <div class="form-group">
            <label for="courseSelect">Course</label>
            <select id="courseSelect" class="form-control" required>
                <option value="">-- Select Course --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="studentSelect">Etudiant</label>
            <select id="studentSelect" class="form-control" required>
                <option value="">-- Select Student --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="noteExamen">Note Examen</label>
            <input type="number" step="0.01" min="0" class="form-control" id="noteExamen">
        </div>
        <div class="form-group">
            <label for="noteDs">Note DS</label>
            <input type="number" step="0.01" min="0" class="form-control" id="noteDs">
        </div>
        <div class="form-group">
            <label for="noteOral">Note Oral</label>
            <input type="number" step="0.01" min="0" class="form-control" id="noteOral">
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </form>

    <div id="message" class="mt-3"></div>
</div>

<script>
    const noteId = window.location.pathname.split('/').pop();
    let currentRole = null;
    let existingNote = null;

    document.addEventListener('DOMContentLoaded', async () => {
        currentRole = await fetchRole();
        await fetchCourses();
        await fetchNote();
    });

    document.getElementById('courseSelect').addEventListener('change', async () => {
        if (currentRole === 'FORMATEUR') {
            await fetchStudentsForCourse();
        }
    });

    document.getElementById('noteForm').addEventListener('submit', updateNote);

    async function fetchRole() {
        try {
            const response = await fetch('/auth/me', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                return data.role;
            }
        } catch (error) {
            console.error('Role fetch error:', error);
        }
        return null;
    }

    async function fetchCourses() {
        const select = document.getElementById('courseSelect');
        const endpoint = currentRole === 'FORMATEUR' ? '/cours/me' : '/cours/';
        try {
            const response = await fetch(endpoint, { credentials: 'include' });
            if (response.ok) {
                const courses = await response.json();
                courses.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.code;
                    option.textContent = `${c.code} - ${c.titre}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching courses:', error);
        }
    }

    async function fetchStudents() {
        const select = document.getElementById('studentSelect');
        try {
            const response = await fetch('/etudiants/', { credentials: 'include' });
            if (response.ok) {
                const students = await response.json();
                students.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = `${e.nom} ${e.prenom} (ID: ${e.id})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching students:', error);
        }
    }

    async function fetchStudentsForCourse() {
        const courseCode = document.getElementById('courseSelect').value;
        const select = document.getElementById('studentSelect');
        select.innerHTML = '<option value="">-- Select Student --</option>';

        if (!courseCode) return;

        try {
            const response = await fetch(`/inscriptions/by-course/${courseCode}`, { credentials: 'include' });
            if (response.ok) {
                const inscriptions = await response.json();
                inscriptions.forEach(insc => {
                    if (!insc.etudiant) return;
                    const option = document.createElement('option');
                    option.value = insc.etudiant.id;
                    option.textContent = `${insc.etudiant.nom} ${insc.etudiant.prenom} (ID: ${insc.etudiant.id})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching students:', error);
        }
    }

    async function fetchNote() {
        const messageDiv = document.getElementById('message');
        try {
            const response = await fetch(`/notes/${noteId}`, { credentials: 'include' });
            if (!response.ok) {
                messageDiv.innerHTML = `<div class="alert alert-danger">Failed to load note. Status: ${response.status}</div>`;
                return;
            }

            existingNote = await response.json();
            document.getElementById('noteExamen').value = existingNote.noteExamen;
            document.getElementById('noteDs').value = existingNote.noteDs;
            document.getElementById('noteOral').value = existingNote.noteOral;
            document.getElementById('courseSelect').value = existingNote.cours ? existingNote.cours.code : '';

            if (currentRole === 'ADMIN') {
                await fetchStudents();
                document.getElementById('studentSelect').value = existingNote.etudiant ? existingNote.etudiant.id : '';
            } else {
                await fetchStudentsForCourse();
                document.getElementById('studentSelect').value = existingNote.etudiant ? existingNote.etudiant.id : '';
                document.getElementById('courseSelect').setAttribute('disabled', 'disabled');
                document.getElementById('studentSelect').setAttribute('disabled', 'disabled');
            }

            document.getElementById('noteForm').style.display = 'block';
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error loading note.</div>';
            console.error('Fetch error:', error);
        }
    }

    async function updateNote(e) {
        e.preventDefault();
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = '';

        const noteExamen = parseFloat(document.getElementById('noteExamen').value);
        const noteDs = parseFloat(document.getElementById('noteDs').value);
        const noteOral = parseFloat(document.getElementById('noteOral').value);
        const payload = {
            noteExamen: Number.isFinite(noteExamen) ? noteExamen : 0,
            noteDs: Number.isFinite(noteDs) ? noteDs : 0,
            noteOral: Number.isFinite(noteOral) ? noteOral : 0,
            etudiant: { id: parseInt(document.getElementById('studentSelect').value, 10) },
            cours: { code: document.getElementById('courseSelect').value }
        };

        try {
            const response = await fetch(`/notes/${noteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });

            if (response.ok) {
                messageDiv.innerHTML = '<div class="alert alert-success">Note updated successfully.</div>';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">Update failed: ${errorText || 'Server error'}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error updating note.</div>';
            console.error('Update error:', error);
        }
    }
</script>
</body>
</html>
