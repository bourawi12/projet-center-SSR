<!DOCTYPE html>
<html>
<head>
    <title>Edit Course</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Edit Course</h2>
    <p><a href="/admin/courses">Back to Course List</a></p>

    <form id="editCourseForm" style="display:none;">
        <div class="form-group">
            <label for="code">Course Code (Read Only)</label>
            <input type="text" class="form-control" id="code" readonly>
        </div>
        <div class="form-group">
            <label for="titre">Title</label>
            <input type="text" class="form-control" id="titre" required>
        </div>
        <div class="form-group">
            <label for="formateur">Formateur (Select ID)</label>
            <select class="form-control" id="formateur">
                <option value="">-- Unassigned --</option>
            </select>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="actif">
            <label class="form-check-label" for="actif">Active</label>
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>

    <div id="message" class="mt-3"></div>
</div>

<script>
    const courseCode = window.location.pathname.split('/').pop();
    const messageDiv = document.getElementById('message');
    const form = document.getElementById('editCourseForm');

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchFormateurs();
        await fetchCourse();
    });

    async function fetchFormateurs() {
        const select = document.getElementById('formateur');
        try {
            const response = await fetch('/formateurs/', { credentials: 'include' });
            if (response.ok) {
                const formateurs = await response.json();
                formateurs.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = `${f.nom} (ID: ${f.id})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching formateurs:', error);
        }
    }

    async function fetchCourse() {
        if (!courseCode) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Invalid course code.</div>';
            return;
        }

        try {
            const response = await fetch(`/cours/${courseCode}`, { credentials: 'include' });
            if (response.ok) {
                const course = await response.json();
                document.getElementById('code').value = course.code;
                document.getElementById('titre').value = course.titre;
                document.getElementById('actif').checked = !!course.actif;

                if (course.formateur && course.formateur.id) {
                    document.getElementById('formateur').value = course.formateur.id;
                }

                form.style.display = 'block';
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">Error loading course. Status: ${response.status}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error loading course.</div>';
            console.error('Fetch error:', error);
        }
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const selectedFormateurId = document.getElementById('formateur').value;
        const payload = {
            code: document.getElementById('code').value,
            titre: document.getElementById('titre').value,
            actif: document.getElementById('actif').checked,
            formateur: selectedFormateurId ? { id: selectedFormateurId } : null
        };

        try {
            const response = await fetch(`/cours/${courseCode}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });

            if (response.ok) {
                messageDiv.innerHTML = '<div class="alert alert-success">Course updated successfully!</div>';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">Update failed: ${errorText || 'Server error'}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error during update.</div>';
            console.error('Update error:', error);
        }
    });
</script>
</body>
</html>
