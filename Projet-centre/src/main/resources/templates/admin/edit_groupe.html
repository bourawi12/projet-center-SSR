<!DOCTYPE html>
<html>
<head>
    <title>Edit Groupe</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Edit Groupe</h2>
    <p><a href="/admin/groupes">Back to Groupes</a></p>

    <form id="groupeForm" style="display:none;">
        <div class="form-group">
            <label for="nom">Nom</label>
            <input type="text" class="form-control" id="nom" required>
        </div>
        <div class="form-group">
            <label for="sessionSelect">Session</label>
            <select id="sessionSelect" class="form-control">
                <option value="">-- None --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="specialiteSelect">Specialite</label>
            <select id="specialiteSelect" class="form-control">
                <option value="">-- None --</option>
            </select>
        </div>
        <div class="form-group">
            <label>Cours</label>
            <div class="row">
                <div class="col-md-5">
                    <small>Disponibles</small>
                    <select id="coursAvailable" class="form-control" size="8"></select>
                </div>
                <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="addCoursBtn">Add &gt;&gt;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="removeCoursBtn">&lt;&lt; Remove</button>
                </div>
                <div class="col-md-5">
                    <small>Selectionnes</small>
                    <select id="coursSelected" class="form-control" size="8"></select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Etudiants</label>
            <div class="row">
                <div class="col-md-5">
                    <small>Disponibles</small>
                    <select id="etudiantsAvailable" class="form-control" size="10"></select>
                </div>
                <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="addEtudiantBtn">Add &gt;&gt;</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="removeEtudiantBtn">&lt;&lt; Remove</button>
                </div>
                <div class="col-md-5">
                    <small>Selectionnes</small>
                    <select id="etudiantsSelected" class="form-control" size="10"></select>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
    </form>

    <div id="message" class="mt-3"></div>
</div>

<script>
    const groupeId = window.location.pathname.split('/').pop();
    document.addEventListener('DOMContentLoaded', init);
    document.getElementById('groupeForm').addEventListener('submit', saveGroupe);
    document.getElementById('addCoursBtn').addEventListener('click', () => moveSelected('coursAvailable', 'coursSelected'));
    document.getElementById('removeCoursBtn').addEventListener('click', () => moveSelected('coursSelected', 'coursAvailable'));
    document.getElementById('addEtudiantBtn').addEventListener('click', () => moveSelected('etudiantsAvailable', 'etudiantsSelected'));
    document.getElementById('removeEtudiantBtn').addEventListener('click', () => moveSelected('etudiantsSelected', 'etudiantsAvailable'));

    async function init() {
        await Promise.all([fetchSessions(), fetchSpecialites(), fetchCours(), fetchEtudiants()]);
        await fetchGroupe();
    }

    async function fetchSessions() {
        const select = document.getElementById('sessionSelect');
        const response = await fetch('/sessions/', { credentials: 'include' });
        if (response.ok) {
            const sessions = await response.json();
            sessions.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.semestre} - ${s.anneeScolaire}`;
                select.appendChild(option);
            });
        }
    }

    async function fetchSpecialites() {
        const select = document.getElementById('specialiteSelect');
        const response = await fetch('/specialites/', { credentials: 'include' });
        if (response.ok) {
            const specs = await response.json();
            specs.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.nom;
                select.appendChild(option);
            });
        }
    }

    async function fetchCours() {
        const select = document.getElementById('coursAvailable');
        const response = await fetch('/cours/', { credentials: 'include' });
        if (response.ok) {
            const courses = await response.json();
            courses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.code;
                option.textContent = `${c.code} - ${c.titre}`;
                select.appendChild(option);
            });
        }
    }

    async function fetchEtudiants() {
        const select = document.getElementById('etudiantsAvailable');
        const response = await fetch('/etudiants/', { credentials: 'include' });
        if (response.ok) {
            const etudiants = await response.json();
            etudiants.forEach(e => {
                const option = document.createElement('option');
                option.value = e.id;
                option.textContent = `${e.nom} ${e.prenom} (ID: ${e.id})`;
                select.appendChild(option);
            });
        }
    }

    async function fetchGroupe() {
        const messageDiv = document.getElementById('message');
        try {
            const response = await fetch(`/groupes/${groupeId}`, { credentials: 'include' });
            if (!response.ok) {
                messageDiv.innerHTML = `<div class="alert alert-danger">Failed to load groupe. Status: ${response.status}</div>`;
                return;
            }
            const g = await response.json();
            document.getElementById('nom').value = g.nom || '';
            document.getElementById('sessionSelect').value = g.session ? g.session.id : '';
            document.getElementById('specialiteSelect').value = g.specialite ? g.specialite.id : '';

            if (g.cours) {
                const selected = new Set(g.cours.map(c => c.code));
                moveItemsByValue('coursAvailable', 'coursSelected', selected);
            }

            if (g.etudiants) {
                const selectedE = new Set(g.etudiants.map(e => e.id));
                moveItemsByValue('etudiantsAvailable', 'etudiantsSelected', selectedE);
            }

            document.getElementById('groupeForm').style.display = 'block';
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error.</div>';
        }
    }

    async function saveGroupe(e) {
        e.preventDefault();
        const messageDiv = document.getElementById('message');
        const coursCodes = [...document.getElementById('coursSelected').options].map(o => o.value);
        const etudiantIds = [...document.getElementById('etudiantsSelected').options].map(o => parseInt(o.value, 10));

        const payload = {
            nom: document.getElementById('nom').value,
            sessionId: document.getElementById('sessionSelect').value || null,
            specialiteId: document.getElementById('specialiteSelect').value || null,
            coursCodes,
            etudiantIds
        };

        try {
            const response = await fetch(`/groupes/${groupeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include'
            });
            if (response.ok) {
                messageDiv.innerHTML = '<div class="alert alert-success">Groupe updated.</div>';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">Update failed: ${errorText || 'Server error'}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error.</div>';
        }
    }

    function moveSelected(fromId, toId) {
        const from = document.getElementById(fromId);
        const to = document.getElementById(toId);
        const selected = [...from.selectedOptions];
        selected.forEach(opt => {
            from.removeChild(opt);
            to.appendChild(opt);
        });
    }

    function moveItemsByValue(fromId, toId, values) {
        const from = document.getElementById(fromId);
        const to = document.getElementById(toId);
        const items = [...from.options].filter(o => values.has(parseInt(o.value, 10)) || values.has(o.value));
        items.forEach(opt => {
            from.removeChild(opt);
            to.appendChild(opt);
        });
    }
</script>
</body>
</html>
