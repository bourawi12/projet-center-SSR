<!DOCTYPE html>
<html>
<head>
    <title>Manage Notes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Notes (Formateur View)</h2>
    <p>
        <a href="/welcome.html">Back to Dashboard</a> |
        <a href="/formateur/notes/new" class="btn btn-success btn-sm">Add Note</a>
    </p>

    <div class="mb-4">
        <h5>My Courses</h5>
        <div id="courseList" class="list-group"></div>
    </div>

    <table class="table table-striped mt-4">
        <thead>
            <tr>
                <th>ID</th>
                <th>Etudiant</th>
                <th>Course</th>
                <th>Examen</th>
                <th>DS</th>
                <th>Oral</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="noteList">
            <tr><td colspan="7" class="text-center">Select a course to view notes.</td></tr>
        </tbody>
    </table>
    <div id="message" class="mt-3"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', fetchCourses);

    async function fetchCourses() {
        const list = document.getElementById('courseList');
        const messageDiv = document.getElementById('message');
        list.innerHTML = '';

        try {
            const response = await fetch('/cours/me', { credentials: 'include' });
            if (response.ok) {
                const courses = await response.json();
                if (courses.length === 0) {
                    list.innerHTML = '<div class="text-muted">No courses found.</div>';
                    return;
                }

                courses.forEach(c => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${c.code} - ${c.titre}`;
                    item.addEventListener('click', () => fetchNotesByCourse(c.code, c.titre));
                    list.appendChild(item);
                });
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">Error loading courses. Status: ${response.status}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error fetching courses.</div>';
            console.error('Fetch error:', error);
        }
    }

    let currentCourseCode = '';
    let currentCourseTitle = '';

    async function fetchNotesByCourse(code, title) {
        const listBody = document.getElementById('noteList');
        const messageDiv = document.getElementById('message');
        const heading = document.querySelector('h2');
        currentCourseCode = code;
        currentCourseTitle = title;
        heading.textContent = `Notes for ${code} - ${title} (Formateur View)`;

        try {
            const response = await fetch(`/notes/by-course/${code}`, { credentials: 'include' });

            if (response.ok) {
                const notes = await response.json();
                listBody.innerHTML = '';

                if (notes.length === 0) {
                    listBody.innerHTML = '<tr><td colspan="7" class="text-center">No notes found.</td></tr>';
                    return;
                }

                notes.forEach(n => {
                    const row = listBody.insertRow();
                    row.insertCell().textContent = n.id;
                    const etu = n.etudiant ? `${n.etudiant.nom} ${n.etudiant.prenom}` : 'N/A';
                    const cours = n.cours ? `${n.cours.code} - ${n.cours.titre}` : 'N/A';
                    row.insertCell().textContent = etu;
                    row.insertCell().textContent = cours;
                    row.insertCell().textContent = n.noteExamen;
                    row.insertCell().textContent = n.noteDs;
                    row.insertCell().textContent = n.noteOral;
                    row.insertCell().innerHTML = `
                        <a class="btn btn-sm btn-info" href="/formateur/notes/edit/${n.id}">Edit</a>
                        <button class="btn btn-sm btn-danger" onclick="deleteNote(${n.id})">Delete</button>
                    `;
                });
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">Error loading notes. Status: ${response.status}. Access denied?</div>`;
                listBody.innerHTML = '';
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error fetching notes.</div>';
            console.error('Fetch error:', error);
        }
    }

    async function deleteNote(id) {
        if (!confirm('Delete this note?')) return;
        const messageDiv = document.getElementById('message');

        try {
            const response = await fetch(`/notes/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.status === 204) {
                messageDiv.innerHTML = '<div class="alert alert-success">Note deleted.</div>';
                if (currentCourseCode) {
                    fetchNotesByCourse(currentCourseCode, currentCourseTitle);
                }
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">Delete failed: ${errorText || 'Server error'}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Network error deleting note.</div>';
            console.error('Delete error:', error);
        }
    }
</script>
</body>
</html>
